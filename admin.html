<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Panel | BarcoApp</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #22d3ee;
            --secondary: #a855f7;
            --dark-bg: #020617;
            --card-bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--dark-bg); 
            color: var(--text-main); 
            margin: 0; 
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* HEADER */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--surface);
            margin-bottom: 30px;
        }

        /* ESTATÍSTICAS RÁPIDAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--surface);
            text-align: center;
        }

        .stat-card i { font-size: 1.5rem; color: var(--primary); margin-bottom: 10px; }
        .stat-card h4 { margin: 5px 0; font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; }
        .stat-card span { font-size: 1.8rem; font-weight: 800; display: block; }

        /* LAYOUT PRINCIPAL */
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        @media (max-width: 1100px) { .main-layout { grid-template-columns: 1fr; } }

        .panel-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid var(--surface);
            margin-bottom: 25px;
        }

        .panel-card h3 {
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        /* TABELA DE BARCOS */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--surface); }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.02); vertical-align: middle; }
        
        .boat-row-info { display: flex; align-items: center; gap: 12px; }
        .mini-img { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; background: var(--surface); }

        /* RANKING */
        .rank-user-item {
            background: var(--surface);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--secondary);
        }

        .progress-bar-bg { width: 100%; height: 6px; background: #020617; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 10px; }

        /* BOTÕES */
        .btn-action {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-save { background: var(--primary); color: var(--dark-bg); }
        .btn-clear { background: var(--danger); color: white; margin-top: 10px; width: 100%; }
        .btn-del-small { background: rgba(239, 68, 68, 0.1); color: var(--danger); width: 35px; height: 35px; border-radius: 8px; }

        .input-box {
            width: 100%;
            background: var(--surface);
            border: 1px solid #334155;
            color: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            outline: none;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="admin-header">
        <div>
            <h1 style="margin:0; font-weight:800; letter-spacing:-1px;">DASHBOARD <span style="color:var(--primary)">ADMIN</span></h1>
            <p style="margin:0; color:var(--text-dim); font-size:0.9rem;">Controle total do BarcoApp</p>
        </div>
        <div id="sync-status" style="font-size:0.8rem; background: var(--success); color: var(--dark-bg); padding:5px 15px; border-radius:20px; font-weight:700;">
            <i class="fas fa-sync fa-spin"></i> LIVE
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-ship"></i>
            <h4>Barcos Ativos</h4>
            <span id="stat-total-boats">0</span>
        </div>
        <div class="stat-card">
            <i class="fas fa-heart"></i>
            <h4>Total Likes</h4>
            <span id="stat-total-likes">0</span>
        </div>
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <h4>Parceiros</h4>
            <span id="stat-total-users">0</span>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-plus"></i>
            <h4>Indicações</h4>
            <span id="stat-total-invites">0</span>
        </div>
    </div>

    <div class="main-layout">
        <aside>
            <div class="panel-card">
                <h3><i class="fas fa-bullhorn"></i> Anúncio Global</h3>
                <input type="text" id="ad-img" class="input-box" placeholder="URL da Imagem do Banner">
                <input type="text" id="ad-link" class="input-box" placeholder="Link do WhatsApp/Site">
                <button class="btn-action btn-save" onclick="saveAd()" style="width:100%">ATUALIZAR BANNER</button>
            </div>

            <div class="panel-card">
                <h3><i class="fas fa-trophy"></i> Ranking de Engajamento</h3>
                <div id="ranking-container">
                    </div>
            </div>

            <div class="panel-card" style="border-color: var(--danger);">
                <h3 style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Zona de Risco</h3>
                <p style="font-size:0.75rem; color:var(--text-dim);">Apague todos os barcos para iniciar uma nova semana de escalas.</p>
                <button class="btn-action btn-clear" onclick="clearAllBoats()">LIMPAR TODA A ESCALA</button>
            </div>
        </aside>

        <main>
            <div class="panel-card">
                <h3><i class="fas fa-list-ul"></i> Escala Completa de Barcos</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Barco</th>
                                <th>Origem/Destino</th>
                                <th>Dia/Hora</th>
                                <th>Engajamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="boat-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    // CONFIGURAÇÃO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDe8vErlAxcDpYqZygWcZAaWT1vGX1P_BM",
        authDomain: "barcoapp-c0f00.firebaseapp.com",
        databaseURL: "https://barcoapp-c0f00-default-rtdb.firebaseio.com",
        projectId: "barcoapp-c0f00",
        storageBucket: "barcoapp-c0f00.firebasestorage.app",
        messagingSenderId: "575071745494",
        appId: "1:575071745494:web:63c1db8d2c1038c27c6077"
    };
    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    function init() {
        // Carregar Anúncio Atual
        rtdb.ref('config/anuncio').once('value', s => {
            const d = s.val();
            if(d) {
                document.getElementById('ad-img').value = d.img || "";
                document.getElementById('ad-link').value = d.link || "";
            }
        });

        // Ouvinte em Tempo Real para Barcos e Indicações
        rtdb.ref('barcos').on('value', boatSnap => {
            rtdb.ref('indicacoes').once('value', indSnap => {
                renderDashboard(boatSnap.val(), indSnap.val() || {});
            });
        });
    }

    function renderDashboard(allDays, allInds) {
        const table = document.getElementById('boat-table-body');
        const ranking = document.getElementById('ranking-container');
        table.innerHTML = "";
        ranking.innerHTML = "";

        let stats = { boats: 0, likes: 0, users: {}, invites: 0 };

        if(allDays) {
            for(let day in allDays) {
                for(let key in allDays[day]) {
                    const b = allDays[day][key];
                    stats.boats++;
                    stats.likes += (b.likes || 0);
                    
                    if(b.registeredBy) {
                        if(!stats.users[b.registeredBy]) {
                            const nInvites = allInds[b.registeredBy] ? Object.keys(allInds[b.registeredBy]).length : 0;
                            stats.users[b.registeredBy] = { name: b.name.split(' ')[0], likes: 0, invites: nInvites };
                        }
                        stats.users[b.registeredBy].likes += (b.likes || 0);
                    }

                    // Render Tabela
                    const row = `
                        <tr>
                            <td>
                                <div class="boat-row-info">
                                    <img src="${b.img || 'https://via.placeholder.com/50'}" class="mini-img">
                                    <div><b>${b.name}</b><br><small style="color:var(--text-dim)">${b.registeredBy}</small></div>
                                </div>
                            </td>
                            <td><small>${b.origin} <i class="fas fa-arrow-right"></i> ${b.destiny}</small></td>
                            <td><span style="color:var(--primary)">${day}</span><br><small>${b.time}h</small></td>
                            <td>
                                <i class="fas fa-heart" style="color:var(--danger)"></i> ${b.likes || 0}<br>
                                <small style="color:var(--success)">R$ ${b.price_p || '0'}</small>
                            </td>
                            <td>
                                <button class="btn-action btn-del-small" onclick="deleteBoat('${day}', '${key}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                }
            }
        }

        // Atualizar Cards de Stats
        document.getElementById('stat-total-boats').innerText = stats.boats;
        document.getElementById('stat-total-likes').innerText = stats.likes.toLocaleString();
        document.getElementById('stat-total-users').innerText = Object.keys(stats.users).length;
        
        let totalInvites = 0;
        Object.values(allInds).forEach(i => totalInvites += Object.keys(i).length);
        document.getElementById('stat-total-invites').innerText = totalInvites;

        // Render Ranking
        const sortedUsers = Object.entries(stats.users).sort((a,b) => b[1].likes - a[1].likes);
        sortedUsers.forEach(([phone, data], index) => {
            const perc = Math.min((data.likes / 1000) * 100, 100);
            ranking.innerHTML += `
                <div class="rank-user-item">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <b>${index+1}º ${data.name}</b>
                        <small style="color:var(--primary)">${data.likes} likes</small>
                    </div>
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-top:5px;">Amigos convidados: ${data.invites}</div>
                    <div class="progress-bar-bg"><div class="progress-fill" style="width:${perc}%"></div></div>
                </div>
            `;
        });
    }

    function saveAd() {
        const img = document.getElementById('ad-img').value;
        const link = document.getElementById('ad-link').value;
        rtdb.ref('config/anuncio').set({ img, link, active: true })
            .then(() => alert("✅ Banner atualizado com sucesso!"));
    }

    function deleteBoat(day, key) {
        if(confirm("Deseja excluir este barco?")) {
            rtdb.ref(`barcos/${day}/${key}`).remove();
        }
    }

    function clearAllBoats() {
        if(confirm("⚠️ ATENÇÃO: Isso apagará TODOS os barcos da escala. Deseja continuar?")) {
            rtdb.ref('barcos').remove();
        }
    }

    init();
</script>

</body>
</html>
